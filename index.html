<!DOCTYPE html>
<html>
<head>
	<title>Audiotool MIDI Export</title>
	<meta charset="utf-8">
	<meta name="viewport"  content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="hsla(227, 50%, 60%, 1)" />
	<link href='./css/grid.bootstrap.min.css' rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Josefin+Sans:400,700' rel='stylesheet' type='text/css'>
	<script type="text/javascript" src="./libs/jsmidgen.js"></script>
	<script type="text/javascript" src="./libs/FileSaver.min.js"></script>
	<style>
	::selection {    background: hsla(227, 50%, 80%, 0.8); }

	::-webkit-scrollbar
	{
		width: .7em; 
		background: hsla(156, 45%, 80%, 1);
	}

	::-webkit-scrollbar-thumb
	{
		background 	: hsla(227, 50%, 60%, 1);
		border 		: hsla(156, 45%, 80%, 1) solid 2px;
		border-radius: 5px;
	}

	input:-webkit-autofill
	{
	    box-shadow 				: hsla(227, 50%, 60%, 1) 0 0 0 18px inset;
	    -webkit-text-fill-color : hsla(227, 50%, 60%, 1);
	}

	::-webkit-input-placeholder { color: hsla(227, 50%, 30%, 0.7); }

	html,
	.main
	{ 
		background 	: hsla(156, 45%, 80%, 1);
		color 		: hsla(227, 50%, 60%, 1);
		font-family: 'Josefin Sans', sans-serif;
	}

	#banner
	{
		font-weight	: 800;
		font-size  	: 350%; 
		text-align	: center;
		padding-top 	: 50px;
		padding-bottom	: 50px;
		text-shadow	: hsla(227, 50%, 50%, 0.8) 0px 2px,
					  hsla(227, 50%, 40%, 0.6) 0px 4px;
	}

	h1
	{
		text-align: center;
		font-size: 250%; 
		text-shadow: hsla(227, 50%, 50%, 0.8) 0px 1px,
					 hsla(227, 50%, 40%, 0.6) 0px 2px;
	}

	#auth input[type="text"], 
	#auth input[type="password"], 
	#fileName
	{
		width 			: 100%;
		font-size 		: 125%;
		background 		: transparent; 
		color 			: hsla(227, 50%, 40%, 1);
		border 			: none;
		border-bottom 	: 2px solid hsla(227, 50%, 60%, 1);
		border-radius 	: 0;  
		padding 		: 3px 15px; 
		margin 			: 2px auto;
		transition 		: .25s all ease;
	}

	#auth input[type="text"]:focus,
	#auth input[type="password"]:focus,
	#fileName:focus
	{
		outline: none;
	}

	.ccirc
	{ 
		height 		: 1px;
		background 	: hsla(227, 50%, 60%, 1);  
		border-left : 15px hsla(156, 45%, 80%, 1) solid;
		border-right: 15px hsla(156, 45%, 80%, 1) solid;
	}

	.arrowdown { 	margin-top: 49.5px; margin-bottom: 49.5px; }
	.arrowdown:before
	{ 
		content 	: "âž¤";
		transform 	: rotateZ(90deg);
		position 	: absolute;
		left 		: 50%; 
		background 	: hsla(227, 50%, 60%, 1);
		box-shadow 	: hsla(227, 50%, 40%, 1) 1px 0px;
		text-shadow : hsla(156, 45%, 50%, 1) 2px 0px;
		text-align	: center;
		color 		: hsla(156, 45%, 80%, 1); 
		border-radius:50%;
		width 		: 50px;
		height 		: 50px; 
		margin-left	:-25px;
		margin-top	:-25px;
		line-height	: 16.67px;
		padding 	: 16.67px;
	}

	.slashes { 		margin-top: 15px; margin-bottom: 15px; }
	.slashes:before
	{ 
		content 	: "///";
		position 	: absolute;
		left 		: 50%;
		text-align	: center;
		font-size 	: 30px;
		line-height : 30px;
		width 		: 30px;
		height 		: 30px; 
		margin-left	:-15px;
		margin-top	:-15px;
		  
	}

	.btn
	{
		margin 		: 10px auto; 
		width 		: 100%;
		background 	: hsla(227, 50%, 60%, 1);
		color 		: hsla(156, 45%, 80%, 1);
		box-shadow 	: hsla(227, 50%, 30%, 0.8) 0 3px;  
		border 		: none;
		border-radius:5px;
		padding 	: 3px 5px; 
		font-size 	: 125%; font-weight: bold;
		transition 	: .25s all ease;
	}

	.btn:hover { 	box-shadow: hsla(227, 50%, 30%, 0.9) 0 2px;  }

	.btn:focus {
		outline		: none;
		box-shadow	: none;
	}

	.tab {
		background 	: hsla(227, 50%, 60%, 0.7);
		color 		: hsla(156, 45%, 80%, 1);
		border-top-left-radius: 5px;
		border-top-right-radius: 5px;
		font-size 	: 125%;
		font-weight : bold;
		text-align 	: center;
		cursor 		: pointer;
		transition 	: .25s all ease;
	}
	.tab:not(.active):hover { 	background: hsla(227, 50%, 60%, 0.9); }
	.tab.active 			{	background: hsla(227, 50%, 60%, 1); cursor: default; }

	#list
	{
		height 			: 200px;
		border-radius 	: 5px;
		border-top-left-radius: 0;
		border-top-right-radius: 0;
		border 			: hsla(227, 50%, 60%, 1) 5px  solid;
		box-shadow 		: hsla(227, 50%, 40%, 1) 0 3px;
		background 		: hsla(227, 50%, 30%, 1); 
		overflow-y: scroll;
		overflow-x: hidden;
		
	}
	#list li
	{
		list-style 	: none;
		background 	: rgba(255, 255, 255, 0.1);
		color 		: hsla(227, 50%, 90%, 1);
		margin 		: 2px 0px;
		padding 	: 2px 10px;
		font-family : monospace;
		cursor 		: pointer;
		transition 	: .2s all ease;
	}
	#list li:hover {	background: rgba(255,255,255,0.3); }

	#timelineTracks
	{
		height 		: 500px; 
		background 	: hsla(227, 30%, 30%, 1);
		position 	: relative;
		margin 		: 10px auto;
		padding 	: 0;
		border-radius: 5px;
		border-top-right-radius		: 0;
		border-bottom-right-radius	: 0;
		overflow-y 	: auto;
	}

	#timelineTracks>div
	{
		position: absolute;
		height 	: 25px;
		width 	: 100%;
		color	: hsla(227, 30%, 80%, 1);
		padding : 0 10px;
		border-top 		: rgba(250,250,250, 0.2) 0.5px solid;
		white-space 	: nowrap;
		text-overflow 	: ellipsis;
		overflow 		: hidden;
		font-family 	: monospace;
		transition 	: .2s all ease; 
	}

	#timelineItems
	{
		height 		: 500px; 
		background 	: hsla(227, 50%, 30%, 1);
		position 	: relative;
		margin 		: 10px auto;
		border-radius: 5px;
		border-top-left-radius		: 0;
		border-bottom-left-radius	: 0;
		overflow-y 	: auto;
	}

	#timelineItems div
	{
		color 		: #222;
		position 	: absolute;
		height 		: 25px;
		border 		: rgba(20,20,20, 0.8) 0.5px solid;
		box-sizing  : border-box;
		white-space : nowrap;
		text-overflow: ellipsis;
		overflow 	: hidden;
		padding 	: 0 3px;
		font-family : monospace;
		cursor 		: pointer;
		transition 	: .2s all ease; 
	}
	#timelineItems div.active
	{
		border: #222 2px dotted;
		cursor: no-drop;
	}
	#timelineItems div:hover { opacity: 0.8; }	

	#saveBtn
	{
		font-size	: 175%;
		font-weight : 800;
		padding 	: 30px; 
	}
	#saveWrapper
	{
		margin-top		: 50px;
		margin-bottom	: 50px;
	}

	#fileName,
	#ext
	{
		font-size	: 250%;
		margin 		: 10px auto;
		border-bottom-width: 5px;
	}
	#ext
	{
		padding 	: 3px 15px;
		text-align	: center;
	}
	</style>
</head>
<body>
<div class="col-md-12 main">
	<div id="banner" class="col-md-12">
		AUDIOTOOL MIDI EXPORT
	</div>
	<div class="ccirc slashes col-md-6 col-md-offset-3"></div>
	<div id="firstSteps" class="col-md-12">
		<div id="auth" class="col-md-4 col-md-offset-4">
			<h1>AUTHENTICATE</h1>
				<form id="login" autocomplete="off">
					<input id="uname" name="username" type="text" placeholder="Your Username" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"><br>
					<input id="password" name="password" type="password" placeholder="Password"><br>
					<input id="loginBtn" class="btn" type="submit" value="LOG IN" onclick="void(0)">
				</form>
		</div>
		<div class="ccirc arrowdown col-md-4 col-md-offset-4"></div>
		<div id="trackList"class="col-md-4 col-md-offset-4">
			<h1>CHOOSE TRACK</h1>
				<div id="allBtn" class="active tab col-md-6 col-xs-6" >PUBLISHED</div>
				<div id="draftBtn" class="tab col-md-6 col-xs-6">DRAFTS</div><br>
				<div id="list"></div>
		</div>
		<div class="ccirc arrowdown col-md-4 col-md-offset-4" ></div>
	</div>
	<div class="col-md-12" style="text-align:center;">
		<h1> CHOOSE REGIONS TO EXPORT </h1>	
	</div>
	<div id="timeline" class="col-md-12">
		<div id="timelineTracks" class="col-md-1 "></div>
		<div id="timelineItems"  class="col-md-11"></div>
	</div>
	<br>
	<div id="output" class="col-md-12">
		<div id="saveWrapper" class="col-md-4 col-md-offset-4">
			<div class="col-md-10">
				<input id="fileName" type="text" value="" placeholder="fileName">
			</div>
			<div id="ext" class="col-md-2">
				.MID
			</div>
			<input id="saveBtn" class="btn" type="button" value="SAVE MIDI">
		</div>
	</div>
</div>

<script type="text/javascript">
var d = document;
var UI = UI || {};

	UI.buttonLogin 	= d.getElementById("loginBtn");
	UI.listDiv 		= d.getElementById("list");
	UI.fieldFileName= d.getElementById("fileName");
	UI.tabPublished = d.querySelectorAll("#trackList .tab")[0];
	UI.tabDrafts 	= d.querySelectorAll("#trackList .tab")[1];

	UI.shakeElement = function(el) {
		var k = 20;
		(function _() {
			el.style.transform = "translateX("+ (Math.cos(Math.floor(k/5)*Math.PI)*15) +"px)"; 
			if ( k-- > 0 ) 
					{ requestAnimationFrame(_); } 
			else 	{ el.style.transform = "translateX(0)"; }
		})();
	}

	UI.displayError = function(text) {
		var el = d.createElement("div"), 
			els = el.style;
			els.position = "fixed";
			els.color = "white"; els.background = "#f44"; els.padding = "10px 30px"; els.fontSize = "20px"; els.width = "100%"; els.opacity = 0.8;
			els.top = els.left = 0;
			el.textContent = text;
		d.body.appendChild(el);
		setTimeout( function() { d.body.removeChild(el); }, 2000);
	}

	UI.showLoggedIn = function() { 
		d.getElementById("uname").value = User.getUsername();
		UI.buttonLogin.value = "LOG OUT";
		UI.buttonLogin.removeEventListener("click", User.authenticate); 
		UI.buttonLogin.addEventListener("click", User.logOut);
		UI.listAll();
	}

	UI.showLoggedOut = function() {
		d.getElementById("uname").value = "";
		UI.buttonLogin.value = "LOG IN";
		UI.buttonLogin.removeEventListener("click", User.logOut);
		UI.buttonLogin.addEventListener("click", User.authenticate);
	}

	UI.clearList = function() {
		UI.listDiv.innerHTML = "";
	}

	UI.formatName = function(title,key,duration) {
		var wew = Math.round((duration/1000)%60) > 9 ? "" : "0";
		return "["+ Math.floor((duration/1000)/60) + ":" + wew + Math.floor((duration/1000)%60) +"] [" +key+ "] " + title;
	}

	UI.listAll = function(n) { 
		if( !User.isLoggedIn() ) {
			list.innerHTML = "<li> You must log in first! </li>";
			UI.shakeElement(UI.buttonLogin); return;
		}
		UI.clearList();
		if (n !== 1) { DraftFetcher.toggleState(0); DraftFetcher.fetchList(); }
		UI.tabPublished.classList.add("active");
		UI.tabDrafts.classList.remove("active");
	}

	UI.listDrafts = function(n) {
		if( !User.isLoggedIn() ) {
			list.innerHTML = "<li> You must log in first! </li>";
			UI.shakeElement(UI.buttonLogin); return;
		}

		UI.clearList();
		if (n !== 1) { DraftFetcher.toggleState(1); DraftFetcher.fetchList();  }
		UI.tabDrafts.classList.add("active");
		UI.tabPublished.classList.remove("active");
	}

	UI.displayList = function(state, list) { 
		UI.clearList();

		// State 0 : Published
		// State 1 : Drafts
		if( state === 0 ) { UI.listAll(1) } else { UI.listDrafts(1); }
		list.forEach( function(track) {
			var item = d.createElement("li");
			item.textContent = UI.formatName(track.title, track.key, track.duration);
			item.addEventListener("click", function() {
				App.fetchJSON(track.key);
				UI.fieldFileName.value = User.getUsername()+"-"+track.title;
			});
			UI.listDiv.appendChild(item);
		})
	};

	UI.getFileName = function() {
		return UI.fieldFileName.value;
	}

	UI.saveMIDIDisplay = function() {
		if( UI.getFileName() == "" ) { UI.shakeElement(UI.fieldFileName); return; }
		App.saveMIDI();
	}


var User = User || {};

	User.onSuccess = function() { 
		UI.showLoggedIn();
		d.getElementById("password").value = "";
	}

	User.isLoggedIn = function() {
		return (User.getAuthKey() && User.getUsername() && true);
	}

	User.getAuthKey = function() {
		return localStorage.AMELoginKey;
	}

	User.getUsername = function() {
		return localStorage.AMELoginUsername;
	}

	User.checkAuth = function() { 
		if( User.isLoggedIn() ) {
			UI.showLoggedIn(); 
		} else {
			UI.showLoggedOut();
		}
	}

	User.logOut = function() {
		window.localStorage.removeItem("AMELoginKey");
		window.localStorage.removeItem("AMELoginUsername");
		UI.showLoggedOut();
	}

	User.authenticate = function(e) { 
		var form = new FormData( d.getElementById("login") );
		var parser = new DOMParser();

		// Fetch credentials
		fetch("https://api.audiotool.com/users/login/", {
			method: "POST",
			body: form
		}).then( function(response) {
			return response.text();
		}).then( function(body) {
			
			var response = parser.parseFromString(body, "text/xml");
			if 		( response.getElementsByTagName("error").length !== 0 ) { 
				if 	( response.getElementsByTagName("error")[0].getAttribute("id") == 4096 ) UI.displayError("Invalid Username or Password");
				return;
			}
			
			// Assign sessionKey and username
			window.localStorage.AMELoginUsername 	= response.getElementsByTagName("key")[1].innerHTML;
			window.localStorage.AMELoginKey 		= response.getElementsByTagName("key")[0].innerHTML;

			User.onSuccess();

		}).catch( function(e) {
			UI.displayError("Oh no! Something happened: " + e.message);
			throw new Error(e);
		});
	}


var DraftFetcher = DraftFetcher || {};

	// State 0: Published Tracks
	// State 1: All Tracks + Drafts
	
	DraftFetcher.state = 0; 

	DraftFetcher.toggleState = function(x) {
		state = (x === 0)? 0 : 1;
		return state;
	}

	DraftFetcher.fetchList = function() {
		var parser = new DOMParser();
		var tracksOut = [];

		var basedURI = (state === 0)? 
						"https://api.audiotool.com/browse/user/"+ User.getUsername() +"/tracks/?limit=128" : 
						"https://api.audiotool.com/tracks/mine/?limit=128";
		
		fetch( basedURI+"&X-Cular-Session="+ User.getAuthKey() )
			.then( function(response) {
				return response.text();
			}).then( function(body) {

				var response = parser.parseFromString(body, "text/xml");

				if (state === 0 ) { //All

					[].forEach.call( response.getElementsByTagName("track"), function(it) {
						var obj = {
							title 	: it.getAttribute("title"),
							key 	: it.getAttribute("key"),
							duration: it.getAttribute("duration")
						}
						tracksOut.push(obj);
					});

				} else { //Draft

					var keys 		= response.querySelectorAll("track>key");
					var titles 		= response.querySelectorAll("track>name");
					var durations 	= response.querySelectorAll("track>duration");
					var pubes 		= response.querySelectorAll("track>published");
					[].forEach.call(keys, function(it, indx) {
						if(pubes[indx].textContent == "true") return;
						var obj = {
							title 	: titles[indx].textContent,
							key 	: keys[indx].textContent,
							duration: durations[indx].textContent
						}
						tracksOut.push(obj);
					});

				}
				UI.displayList( DraftFetcher.state, tracksOut );
			}).catch( function(e) {
				UI.displayError("Something went wrong: " + e.message);
			});

	}

var TimelineView = TimelineView || {};


	TimelineView.container 		= d.getElementById("timelineItems");
	TimelineView.trackLabels 	= d.getElementById("timelineTracks");

	TimelineView.clearView = function() {
		TimelineView.container.innerHTML = "";
		TimelineView.trackLabels.innerHTML = "";
	}

	TimelineView.toggleRegionDisplay = function(key, state) {
		var regions = d.querySelectorAll('div[data-region-name="'+key+'"]');
		[].forEach.call(regions, function(item) {
			if(state) {
				item.classList.add("active");
			} else {	
				item.classList.remove("active");
			}
		});
	}

	TimelineView.displayData = function(json) {
		TimelineView.clearView();
		var total = json.timeInfo.durationInTicks;
		//Filter Tracks Counter
		var k = 0;

		var trackNames = {}; 

		//Iterating Plugins Looking for Their Names
		for ( var i=0; i < json.plugins.length; i++ ) trackNames[json.plugins[i].plugin.box] = json.plugins[i].plugin.displayName;

		// Iterating Tracks
		for (j = 0 ; j < json.timeline.tracks.length; j++) {

			// Discard everything but NoteRegions
			if ( json.timeline.tracks[j].type == 1 ) {
				
				//Insert TrackNames
				var trackDOM = d.createElement("div");
					trackDOM.style.top = 10 + (k*25) + "px";
				trackDOM.appendChild(d.createTextNode(trackNames[json.timeline.tracks[j].pluginModelBox]));

				TimelineView.trackLabels.appendChild(trackDOM);

				var blocks 		= json.timeline.tracks[j].content.items;
				// Iterating NoteBlockRegions
				for (i = 0 ; i < blocks.length ; i++  ) {

					var blockDOM = d.createElement("div"),
						bs 		 = blockDOM.style,
						regionKey= blocks[i].contentBox;

					// Append Label TextNode to NoteRegions
					blockDOM.appendChild(d.createTextNode(blocks[i].name));

					// Metadata
					blockDOM.setAttribute("data-region-name", regionKey);

					// Stylize and Positioning
						// DEC -> HEX color provided in the format
						bs.backgroundColor = "#"+blocks[i].color.toString(16);
						// X-Position calculated by tickTime
						bs.left  = (blocks[i].position/total)*100 + "%";
						// 10 pixel top padding and 25px regionHeight
						bs.top 	 = 10 + (k*25) + "px";
						// Similar to position
						bs.width = (blocks[i].duration/total)*100 + "%";

					// addEventListener to NoteRegions
					(function(z,key) { 
						z.addEventListener("click", function() { 
							var regionState = App.toggleRegion(key);
							TimelineView.toggleRegionDisplay(key, regionState);
						})
					})(blockDOM, regionKey);

					TimelineView.container.appendChild(blockDOM);
				}
				k++;
			}
		}
			
	}

var App = App || {};
	
	App.currentJSON = {};
	App.regions = [];

	App.getCurrentJSON = function() {
		return App.currentJSON;
	}

	App.toggleRegion = function(regionKey) {
		if( App.regions.indexOf(regionKey) == -1 ) {
			App.regions.push(regionKey);
			return true;
		} else {
			App.regions.splice(App.regions.indexOf(regionKey), 1);
			return false;
		}
	}

	App.fetchJSON = function(key) {
		fetch("https://api.audiotool.com/track/"+key+"/session.json?X-Cular-Session="+ User.getAuthKey() )
			.then( function( response ) {
				return response.json();
			}).then ( function(json) {
				// Clear regions, set new JSON and display
				App.regions = [];
				App.currentJSON = json;
				TimelineView.displayData(json);
			}).catch( function(e) {
				UI.displayError("Something went wrong :O " + e.message);
				throw new Error(e);
			});
	}

	App.saveMIDI = function() {
		if( App.regions.length == 0 ) {
			UI.displayError("You must choose at least one region to export!"); 
			return;
		}

		var file = new Midi.File();

		// Set Tempo
		file.addTrack().setTempo( App.currentJSON.timeInfo.bpm );

		// Through Each Audiotool Track
		for( var i = 0; i < App.regions.length; i++ ) {
			var audiotoolTrack =  App.currentJSON.timeline.contents.findIndex(function(el) { return el.contentBox == App.regions[i]; });

			var thisRegion = App.currentJSON.timeline.contents[audiotoolTrack];
			
			var events = [];

			// Through Each Note
			for( var j = 0; j < thisRegion.items.length; j++) { 
				var note = thisRegion.items[j];

				// Disregard all notes started before the noteRegion starts
				if( note.position < 0 ) continue;

				// Note ON
				events.push({
					type: Midi.Event.NOTE_ON,
					channel: i,
					param1: Midi.Util.ensureMidiPitch(note.note),
					param2: parseInt(note.velocity*127),
					time: note.position,
				});
				// Note OFF
				events.push({
					type: Midi.Event.NOTE_OFF,
					channel: i,
					param1: Midi.Util.ensureMidiPitch(note.note),
					param2: parseInt(note.velocity*127),
					time: note.position + note.duration,
				});
			}

			// Sort Events
			events.sort(function(a, b) {
			  return a.time - b.time;
			});
			// Relative Time
			events = events.map( function(it, ind, arr) { 
				var prev = (arr[ind-1] !== undefined)? arr[ind-1].time : 0;
				return new Midi.Event({
					type: it.type,
					channel: it.channel,
					param1: it.param1,
					param2: it.param2,
					time: it.time - prev,
				});
			});
			//Add to Track
			file.addTrack( new Midi.Track({events: events}) );
		}

		saveAs( new Blob([ new Uint8Array([].map.call(file.toBytes(), function(c) { return c.charCodeAt(0); })).buffer], {type: "application/x-midi"}) , UI.getFileName()+".mid" );
	}

	App.init = function() {
		User.checkAuth();
		d.getElementById("allBtn").addEventListener("click", UI.listAll);
		d.getElementById("draftBtn").addEventListener("click", UI.listDrafts);
		d.getElementById("saveBtn").addEventListener("click", UI.saveMIDIDisplay);

		//Prevent FormSubmit
		d.getElementById("login").addEventListener("submit", function(e) {
			e.preventDefault();
		})
	}

App.init();

</script>
</body>
</html>